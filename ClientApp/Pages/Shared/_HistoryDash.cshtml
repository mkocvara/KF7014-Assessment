@using ClientApp.Data;
@using ClientApp.Data.Repositories;
@inject IHttpClientFactory HttpClientFactory;
@inject IReadOnlyRepository<WeatherMeasurement> AggregateRepository
@{
    HttpClient _httpClient = HttpClientFactory.CreateClient("Gateway");

    Console.WriteLine("Getting Data...");
    IEnumerable<WeatherMeasurement> measurements = await AggregateRepository.GetAll();
    if (!measurements.Any())
    {
        Console.WriteLine("Generating dummy data for development purposes...");

        // Sample data for testing
        PrecipitationMeasurement precip = new PrecipitationMeasurement
                {
                    Location = "City1",
                    DateTime = DateTime.Now.Date,
                    PrecipitationMm = 10.5f,
                    Coverage = 0.8f,
                    Snowfall = 5.0f,
                    SnowDepth = 2.0f,
                    SevereRisk = false
                };

        TemperatureMeasurement temp = new TemperatureMeasurement
                {
                    Location = "City1",
                    DateTime = DateTime.Now.Date,
                    Temperature = 25.0f
                };

        HumidityMeasurement humidity = new HumidityMeasurement
                {
                    Location = "City1",
                    Timestamp = DateTime.Now.Date,
                    Percentage = 60.0f
                };


        WeatherMeasurement weatherData = new WeatherMeasurement(precip, temp, humidity);
        Console.WriteLine($"Adding this data point: {weatherData}");

        measurements = measurements.Append(weatherData);
    }

    Console.WriteLine($"Number of measurements: {measurements.Count()}");

}


<div>
    <label for="dataSelector">Select Data:</label>
    <select id="dataSelector" onchange="updateChart()">
        <option value="temperature">Temperature</option>
        <option value="precipitation">Precipitation</option>
        <option value="humidity">Humidity</option>
    </select>
    <label for="citySelector">Select Location:</label>
    <select id="citySelector" onchange="updateChart()">
    </select>
</div>
<canvas id="sensorChart" width="400" height="200"></canvas>
<!-- Include 'chart.js' library and the date adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    //import {getOptions} from './js/HistoryDash.js';

    var fullData = @Json.Serialize(measurements.ToList());
    console.log(`FULL DATA:`);
    console.log(fullData)

    var selectedData = {};

    // Get the canvas element and create a chart
    var ctx = document.getElementById('sensorChart').getContext('2d');
    var sensorChart = new Chart(ctx, {
        type: 'line', // Chart type (bar, line, etc.)
        data: {
            // labels: selectedDates.map(date => new Date(date).toLocaleDateString()),
            datasets: [
                {
                    label: 'Temperature',
                    data: selectedData,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    showLine: true
                }
            ],
        },
        options: {
            scales: {
                x: {
                    type: 'time', // Specify x-axis type as time
                    time: {
                        unit: 'day' // Display one label per day
                    },
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    function compareDates(a, b) {
        return new Date(a.x) - new Date(b.x);
    }


    // Update based on the selector element
    function updateChart() {
        // Type of collected data
        var dataSelector = document.getElementById('dataSelector');
        var dataSelectedValue = dataSelector.options[dataSelector.selectedIndex].value;
        var dataSelectedText = dataSelector.options[dataSelector.selectedIndex].text;

        // Location
        var citySelector = document.getElementById('citySelector');
        var citySelectedValue = citySelector.options[citySelector.selectedIndex].value;
        var citySelectedText = citySelector.options[citySelector.selectedIndex].text;


        // Update selectedData based on the user's selection
        if (dataSelectedValue === 'temperature') {
            selectedData = fullData.filter(m => m.location === citySelectedValue).map(m => ({ x: m.dateTime, y: m.temperatureC }));
        } else if (dataSelectedValue === 'precipitation') {
            selectedData = fullData.filter(m => m.location === citySelectedValue).map(m => ({ x: m.dateTime, y: m.precipitationMm }));
        } else if (dataSelectedValue === 'humidity') {
            selectedData = fullData.filter(m => m.location === citySelectedValue).map(m => ({ x: m.dateTime, y: m.humidity }));
        }

        // Clean and sort by date
        selectedData.filter(m => m.x !== null && m.y !== null);
        selectedData.sort(compareDates);

        console.log(`SelectedData Sorted:`);
        console.log(selectedData)

        // Update the chart data and re-render
        sensorChart.data.datasets[0].data = selectedData;
        sensorChart.data.datasets[0].label = dataSelectedText;
        sensorChart.update();
    }

    function updateCityOptions() {
        var citySelector = document.getElementById("citySelector");

        // Clear existing options
        citySelector.innerHTML = "";

        // Get unique locations from weatherMeasurements
        var uniqueLocations = [...new Set(fullData.map(m => m.location))];

        // Add options for each unique location
        uniqueLocations.forEach(function (location, index) {
            var option = document.createElement("option");
            option.value = location;
            option.text = location;

            if (index === 0) {
                option.selected = true;
            }

            citySelector.add(option);
        });
    }

    updateCityOptions()

    updateChart();

</script>
